\chapter{ANEXO A - Código Fonte do Robô de Extração de Dados}
\label{cap:anexoa}
\definecolor{dkgreen}{rgb}{0,0.6,0}
\definecolor{gray}{rgb}{0.5,0.5,0.5}
\definecolor{mauve}{rgb}{0.58,0,0.82}

\lstset{frame=tb,
  language=Java,
  aboveskip=3mm,
  belowskip=3mm,
  showstringspaces=false,
  columns=flexible,
  basicstyle={\small\ttfamily},
  numbers=none,
  numberstyle=\tiny\color{gray},
  keywordstyle=\color{blue},
  commentstyle=\color{dkgreen},
  stringstyle=\color{mauve},
  breaklines=true,
  breakatwhitespace=true,
  tabsize=3
}

crawler.java 

\begin{lstlisting}
package crawler;

import java.util.Iterator;
import java.util.List;

import crawler.entity.RedditPost;
import crawler.properties.RedditProperties;
import manager.RedditManager;

public class Crawler {

	
	public static void main(String[] args) {
		
		try {
			for (Iterator<String> iterator = RedditProperties.SELECTED_THREADS.iterator(); iterator.hasNext();) {
				List<RedditPost> postList = Requestor.getPosts(RedditProperties.HTTPS_REDDIT + (String) iterator.next());
				System.out.println("Comentarios " + postList.size());
				RedditManager.savePosts(postList);
			}
			
			RedditManager.shutdown();
			
		} catch (Exception e) {
			e.printStackTrace();
		}
	}

}
\end{lstlisting}

requestor.java

\begin{lstlisting}
package crawler;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.net.HttpURLConnection;
import java.net.MalformedURLException;
import java.net.URL;
import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;

import javax.net.ssl.HttpsURLConnection;
import javax.persistence.EntityManager;

import com.fasterxml.jackson.core.JsonFactory;
import com.fasterxml.jackson.core.JsonParseException;
import com.fasterxml.jackson.core.JsonParser;
import com.fasterxml.jackson.databind.JsonMappingException;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;

import crawler.entity.RedditPost;
import crawler.entity.RedditThread;
import crawler.properties.RedditProperties;
import manager.RedditManager;

public class Requestor {

	private static String getRedditJson(String sUrl) throws IOException {
		sUrl = sUrl + ".json";
		System.out.println("Making Request to: " + sUrl);
		StringBuilder result = new StringBuilder();
		URL url = new URL(sUrl);
		HttpsURLConnection conn = (HttpsURLConnection) url.openConnection();
		conn.setRequestMethod("GET");
		conn.setRequestProperty("User-Agent", "Crawler 0.1");
		BufferedReader rd = new BufferedReader(new InputStreamReader(conn.getInputStream()));

		String line;
		while ((line = rd.readLine()) != null) {
			result.append(line);
		}
		rd.close();

		return result.toString();

	}

	private static List<RedditThread> getThreadsByJson(String json) throws Exception {
		List<RedditThread> threadList = new ArrayList<RedditThread>();
		ObjectMapper objectMapper = new ObjectMapper();

		JsonNode node = objectMapper.readValue(json, JsonNode.class);
		JsonNode jacksonThreads = node.get("data").get("children");
		Iterator<JsonNode> threadIterator = jacksonThreads.elements();
		while (threadIterator.hasNext()) {
			JsonNode iteratorThread = (JsonNode) threadIterator.next();
			RedditThread thread = objectMapper.readValue(iteratorThread.get("data").toString(), RedditThread.class);
			threadList.add(thread);
		}

		return threadList;
	}

	public static List<RedditThread> getThreads(String url) throws Exception {
		return getThreadsByJson(getRedditJson(url));
	}

	public static List<RedditPost> getPosts(String url) throws Exception {
		RedditThread thread = new RedditThread();
		List<RedditPost> postList = new ArrayList<RedditPost>();
		ObjectMapper objectMapper = new ObjectMapper();
		JsonNode node = objectMapper.readValue(getRedditJson(url), JsonNode.class);
		Iterator<JsonNode> postsIterator = node.elements();
		while (postsIterator.hasNext()) {

			JsonNode postsNode = (JsonNode) postsIterator.next();

			// Only the last element has comments in it. The first one contains
			// the thread.
			if (!postsIterator.hasNext()) {
				JsonNode postContentNode = postsNode.get("data").get("children");
				Iterator<JsonNode> postIterator = postContentNode.elements();

				while (postIterator.hasNext()) {
					JsonNode iteratorPost = (JsonNode) postIterator.next();

					RedditPost post = objectMapper.readValue(iteratorPost.get("data").toString(), RedditPost.class);
					if (iteratorPost.get("kind").toString().equals("\"t1\"")) {
						postList.add(post);
						// System.out.println(post.getBody());
					}
					/*
					 * if (post.getReplies() != null &&
					 * !iteratorPost.get("data").get("replies").toString().
					 * equals("\"\"")) {
					 * System.out.println(iteratorPost.get("data").get("replies"
					 * ).toString()); }
					 */
					if (post.getChildren() != null)
						for (String childPost : post.getChildren()) {
							postList.addAll(
									getPosts(RedditProperties.HTTPS_REDDIT + thread.getPermalink() + childPost));
						}
				}
			} else {
				List<RedditThread> threadList = getThreadsByJson(postsNode.toString());
				if (threadList.size() > 1)
					throw new Exception("Post list has more than one thread?!");
				thread = threadList.get(0);
			}
		}
		return postList;
	}

}
\end{lstlisting}

redditproperties.java
\begin{lstlisting}
package crawler.properties;

import java.util.ArrayList;
import java.util.List;

public class RedditProperties {

	public static final String HTTPS_REDDIT = "https://www.reddit.com/";
	
	public static final List<String> SELECTED_THREADS = new ArrayList<>();
	
	//Topicos Selecionados Atraves do TCC
	public RedditProperties(){
		SELECTED_THREADS.add("36ny58");
		SELECTED_THREADS.add("4bqcc3");
		SELECTED_THREADS.add("5oyz3b");
		SELECTED_THREADS.add("21f3as");
		SELECTED_THREADS.add("2t65ql");
		SELECTED_THREADS.add("4d75i7");
		SELECTED_THREADS.add("5exz2e");
		SELECTED_THREADS.add("67ivae");
		SELECTED_THREADS.add("6cqdye");
		SELECTED_THREADS.add("5uzetf");
		SELECTED_THREADS.add("5qqa51");
		SELECTED_THREADS.add("5whpqs");
		SELECTED_THREADS.add("1wl9ic");
		SELECTED_THREADS.add("2s7obx");
		SELECTED_THREADS.add("5n58sm");
	}
	

}
\end{lstlisting}

redditmanager.java

\begin{lstlisting}
package manager;

import java.util.Iterator;
import java.util.List;

import javax.persistence.EntityManager;
import javax.persistence.EntityManagerFactory;
import javax.persistence.Persistence;

import crawler.Requestor;
import crawler.entity.RedditPost;
import crawler.entity.RedditThread;

public class RedditManager {
	private static final String PERSISTENCE_UNIT_NAME = "PERSISTENCE";
	private static EntityManagerFactory factory;
	

	public static EntityManagerFactory getEntityManagerFactory() {
	    if (factory == null) {
	      factory = Persistence.createEntityManagerFactory(PERSISTENCE_UNIT_NAME);
	    }
	    return factory;
	}


	public static void shutdown() {
		if (factory != null) {
			factory.close();
		}
	}

	public static void saveThreads(List<RedditThread> threadList) {
		EntityManager entityManager = getEntityManagerFactory().createEntityManager();
		entityManager.getTransaction().begin();  
		
		
		for (Iterator<RedditThread> iterator = threadList.iterator(); iterator.hasNext();) {
			RedditThread redditThread = (RedditThread) iterator.next();

			entityManager.persist(redditThread);


		}

		entityManager.getTransaction().commit();
		entityManager.close();
	}


	public static void savePosts(List<RedditPost> postList) {
		EntityManager entityManager = getEntityManagerFactory().createEntityManager();
		entityManager.getTransaction().begin();  
		
		
		for (Iterator<RedditPost> iterator = postList.iterator(); iterator.hasNext();) {
			RedditPost redditThread = (RedditPost) iterator.next();

			entityManager.persist(redditThread);


		}

		entityManager.getTransaction().commit();
		entityManager.close();
		
	}

}
\end{lstlisting}